name: Release
on:
  push:
    branches: [main]

env:
  REGISTRY: "k3d-mathtrail-registry:5000"

jobs:
  # JOB 1: Quick re-validation before release
  # Full testing (lint, unit tests, deploy, k6 load tests) already ran in CI on the PR.
  # This catches potential "logic conflicts" between independently tested PRs.
  test:
    runs-on: mathtrail-runners
    steps:
      - uses: actions/checkout@v4

      - name: Lint
        run: just ci-lint

      - name: Run Tests
        run: just ci-test

  # JOB 2: Artifact Production and Delivery
  # This job depends on 'test' and only triggers on the Main branch.
  # It packages the validated code into a Docker image and an OCI Helm chart.
  release:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: mathtrail-runners
    steps:
      - uses: actions/checkout@v4

      - name: Build and Push Docker Image
        run: |
          # Use commit SHA as the image tag for traceability
          just build-push-image "${{ env.REGISTRY }}/mentor-api:${{ github.sha }}"

      - name: Release Helm Chart to OCI
        run: |
          # Push the chart to the same OCI registry
          just release-chart-oci "oci://${{ env.REGISTRY }}/charts"

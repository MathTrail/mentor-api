name: Release
on:
  push:
    branches: [main]

jobs:
  # JOB 1: Post-merge validation
  # Runs unit tests to catch logic conflicts between independently merged PRs.
  # Full CI (lint, deploy, k6 load tests) already passed on each PR.
  test:
    runs-on: mathtrail-runners
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: MathTrail/core/.github/actions/setup-env@v1

      - name: Run Tests
        run: just ci-test

  # JOB 2: Artifact Production and Delivery
  # This job depends on 'test' and only triggers on the Main branch.
  # It packages the validated code into a Docker image and an OCI Helm chart.
  release:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: mathtrail-runners
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: MathTrail/core/.github/actions/setup-env@v1

      - name: Setup
        run: just setup

      - name: Build and Push Docker Image
        run: |
          # Use commit SHA as the image tag for traceability
          just build-push-image "${{ env.REGISTRY_CLUSTER }}/mentor-api:${{ github.sha }}"

      - name: Release Helm Chart to OCI
        run: |
          # Push the chart to the same OCI registry
          just release-chart-oci "oci://${{ env.REGISTRY_CLUSTER }}/charts"

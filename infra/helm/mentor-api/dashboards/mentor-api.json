{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    },
    {
      "name": "DS_LOKI",
      "label": "Loki",
      "description": "",
      "type": "datasource",
      "pluginId": "loki",
      "pluginName": "Loki"
    },
    {
      "name": "DS_TEMPO",
      "label": "Tempo",
      "description": "",
      "type": "datasource",
      "pluginId": "tempo",
      "pluginName": "Tempo"
    }
  ],
  "__requires": [
    { "type": "grafana",    "id": "grafana",    "name": "Grafana",    "version": "10.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" },
    { "type": "datasource", "id": "loki",       "name": "Loki",       "version": "1.0.0" },
    { "type": "datasource", "id": "tempo",      "name": "Tempo",      "version": "1.0.0" },
    { "type": "panel",      "id": "timeseries", "name": "Time series","version": "" },
    { "type": "panel",      "id": "stat",       "name": "Stat",       "version": "" },
    { "type": "panel",      "id": "logs",       "name": "Logs",       "version": "" }
  ],
  "id": null,
  "uid": "mathtrail-mentor-api",
  "title": "mentor-api",
  "description": "Golden signals, Go runtime, business metrics, and logs for mentor-api",
  "tags": ["mathtrail", "mentor-api"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "30s",
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "templating": {
    "list": [
      {
        "name": "datasource",
        "label": "Prometheus Datasource",
        "type": "datasource",
        "pluginId": "prometheus",
        "query": "prometheus",
        "current": {},
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "refresh": 1
      },
      {
        "name": "loki_datasource",
        "label": "Loki Datasource",
        "type": "datasource",
        "pluginId": "loki",
        "query": "loki",
        "current": {},
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "refresh": 1
      },
      {
        "name": "namespace",
        "label": "Namespace",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${datasource}" },
        "query": {
          "query": "label_values(kube_pod_info{pod=~\"mentor-api.*\"}, namespace)",
          "refId": "StandardVariableQuery"
        },
        "current": { "text": "mathtrail", "value": "mathtrail" },
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "refresh": 2,
        "sort": 1
      },
      {
        "name": "pod",
        "label": "Pod",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${datasource}" },
        "query": {
          "query": "label_values(container_cpu_usage_seconds_total{container=\"mentor-api\", namespace=\"$namespace\"}, pod)",
          "refId": "StandardVariableQuery"
        },
        "current": {},
        "hide": 0,
        "includeAll": true,
        "multi": true,
        "refresh": 2,
        "sort": 1
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "row",
      "title": "Golden Signals",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 },
      "panels": []
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "Request Rate (RPS)",
      "description": "Incoming HTTP requests per second, broken down by route",
      "gridPos": { "x": 0, "y": 1, "w": 8, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "sum by (http_route) (rate(http_server_request_duration_seconds_count{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval]))",
          "legendFormat": "{{http_route}}"
        }
      ]
    },
    {
      "id": 3,
      "type": "timeseries",
      "title": "Error Rate (5xx %)",
      "description": "Percentage of requests returning 5xx status codes per route",
      "gridPos": { "x": 8, "y": 1, "w": 8, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "min": 0,
          "max": 1,
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.001 },
              { "color": "red",    "value": 0.01 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "sum by (http_route) (rate(http_server_request_duration_seconds_count{job=\"mentor-api\", namespace=\"$namespace\", http_response_status_code=~\"5..\"}[$__rate_interval])) / sum by (http_route) (rate(http_server_request_duration_seconds_count{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval]))",
          "legendFormat": "{{http_route}}"
        }
      ]
    },
    {
      "id": 4,
      "type": "timeseries",
      "title": "Latency Percentiles",
      "description": "HTTP request latency p50/p95/p99 across all routes. Click to explore traces in Tempo.",
      "gridPos": { "x": 16, "y": 1, "w": 8, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "links": [
        {
          "title": "Explore traces in Tempo",
          "url": "/explore?orgId=1&left=%7B%22datasource%22%3A%22${DS_TEMPO}%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22queryType%22%3A%22traceql%22%2C%22query%22%3A%22%7B.service.name%3D%5C%22mentor-api%5C%22%7D%22%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22${__from}%22%2C%22to%22%3A%22${__to}%22%7D%7D",
          "targetBlank": true
        }
      ],
      "targets": [
        {
          "refId": "p50",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "histogram_quantile(0.50, sum by (le) (rate(http_server_request_duration_seconds_bucket{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval])))",
          "legendFormat": "p50"
        },
        {
          "refId": "p95",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "histogram_quantile(0.95, sum by (le) (rate(http_server_request_duration_seconds_bucket{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval])))",
          "legendFormat": "p95"
        },
        {
          "refId": "p99",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "histogram_quantile(0.99, sum by (le) (rate(http_server_request_duration_seconds_bucket{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval])))",
          "legendFormat": "p99"
        }
      ]
    },
    {
      "id": 5,
      "type": "timeseries",
      "title": "CPU Usage vs Limit",
      "description": "Container CPU usage (cores) versus configured limit",
      "gridPos": { "x": 0, "y": 9, "w": 12, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "limit" },
            "properties": [
              { "id": "custom.lineStyle", "value": { "fill": "dash", "dash": [8, 4] } },
              { "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "sum by (pod) (rate(container_cpu_usage_seconds_total{container=\"mentor-api\", namespace=\"$namespace\", pod=~\"$pod\"}[$__rate_interval]))",
          "legendFormat": "usage — {{pod}}"
        },
        {
          "refId": "B",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "kube_pod_container_resource_limits{container=\"mentor-api\", namespace=\"$namespace\", resource=\"cpu\", pod=~\"$pod\"}",
          "legendFormat": "limit"
        }
      ]
    },
    {
      "id": 6,
      "type": "timeseries",
      "title": "Memory Usage vs Limit",
      "description": "Container working set memory versus configured limit",
      "gridPos": { "x": 12, "y": 9, "w": 12, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "limit" },
            "properties": [
              { "id": "custom.lineStyle", "value": { "fill": "dash", "dash": [8, 4] } },
              { "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "sum by (pod) (container_memory_working_set_bytes{container=\"mentor-api\", namespace=\"$namespace\", pod=~\"$pod\"})",
          "legendFormat": "working set — {{pod}}"
        },
        {
          "refId": "B",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "kube_pod_container_resource_limits{container=\"mentor-api\", namespace=\"$namespace\", resource=\"memory\", pod=~\"$pod\"}",
          "legendFormat": "limit"
        }
      ]
    },
    {
      "id": 7,
      "type": "row",
      "title": "Go Runtime",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 17, "w": 24, "h": 1 },
      "panels": []
    },
    {
      "id": 8,
      "type": "timeseries",
      "title": "Goroutine Count",
      "description": "Number of active goroutines. A sustained upward trend may indicate a goroutine leak.",
      "gridPos": { "x": 0, "y": 18, "w": 8, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "single" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "go_goroutines{job=\"mentor-api\", namespace=\"$namespace\"}",
          "legendFormat": "goroutines"
        }
      ]
    },
    {
      "id": 9,
      "type": "timeseries",
      "title": "Heap Memory",
      "description": "Go heap: in-use bytes, allocated bytes, and idle bytes",
      "gridPos": { "x": 8, "y": 18, "w": 8, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "go_memstats_heap_inuse_bytes{job=\"mentor-api\", namespace=\"$namespace\"}",
          "legendFormat": "in-use"
        },
        {
          "refId": "B",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "go_memstats_heap_alloc_bytes{job=\"mentor-api\", namespace=\"$namespace\"}",
          "legendFormat": "alloc"
        },
        {
          "refId": "C",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "go_memstats_heap_idle_bytes{job=\"mentor-api\", namespace=\"$namespace\"}",
          "legendFormat": "idle"
        }
      ]
    },
    {
      "id": 10,
      "type": "timeseries",
      "title": "GC Duration (p99) & Rate",
      "description": "Garbage collector: p99 pause duration and cycles per second. High GC rate or long pauses indicate memory pressure.",
      "gridPos": { "x": 16, "y": 18, "w": 8, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "GC cycles/s" },
            "properties": [
              { "id": "unit", "value": "ops" },
              { "id": "custom.axisPlacement", "value": "right" }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "histogram_quantile(0.99, rate(go_gc_duration_seconds_bucket{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval]))",
          "legendFormat": "p99 GC pause"
        },
        {
          "refId": "B",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "rate(go_gc_duration_seconds_count{job=\"mentor-api\", namespace=\"$namespace\"}[$__rate_interval])",
          "legendFormat": "GC cycles/s"
        }
      ]
    },
    {
      "id": 11,
      "type": "row",
      "title": "Business Metrics",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 26, "w": 24, "h": 1 },
      "panels": []
    },
    {
      "id": 12,
      "type": "timeseries",
      "title": "Feedback Submissions (RPS)",
      "description": "Rate of POST /api/v1/feedback requests — the core business endpoint",
      "gridPos": { "x": 0, "y": 27, "w": 12, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "lineWidth": 2, "fillOpacity": 10 }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "single" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "sum(rate(http_server_request_duration_seconds_count{job=\"mentor-api\", namespace=\"$namespace\", http_route=\"/api/v1/feedback\", http_method=\"POST\"}[$__rate_interval]))",
          "legendFormat": "feedback/s"
        },
        {
          "refId": "B",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "sum(rate(http_server_request_duration_seconds_count{job=\"mentor-api\", namespace=\"$namespace\", http_route=\"/api/v1/feedback\", http_method=\"POST\", http_response_status_code=~\"5..\"}[$__rate_interval]))",
          "legendFormat": "errors/s"
        }
      ]
    },
    {
      "id": 13,
      "type": "stat",
      "title": "Pod Readiness",
      "description": "Kubernetes readiness condition for mentor-api pods (1 = Ready, 0 = Not Ready)",
      "gridPos": { "x": 12, "y": 27, "w": 12, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "mappings": [
            {
              "type": "value",
              "options": {
                "1": { "text": "Ready",     "color": "green" },
                "0": { "text": "Not Ready", "color": "red" }
              }
            },
            {
              "type": "special",
              "options": {
                "match": "null",
                "result": { "text": "No Data", "color": "yellow" }
              }
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red",   "value": null },
              { "color": "green", "value": 1 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "orientation": "auto",
        "textMode": "auto",
        "colorMode": "background",
        "graphMode": "none"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "expr": "kube_pod_status_ready{namespace=\"$namespace\", pod=~\"mentor-api.*\", condition=\"true\"}",
          "legendFormat": "{{pod}}"
        }
      ]
    },
    {
      "id": 14,
      "type": "row",
      "title": "Logs",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 35, "w": 24, "h": 1 },
      "panels": []
    },
    {
      "id": 15,
      "type": "logs",
      "title": "Error / Warn Logs",
      "description": "Structured JSON logs from mentor-api at level error or warn. Uses Zap JSON output parsed via LogQL | json.",
      "gridPos": { "x": 0, "y": 36, "w": 24, "h": 10 },
      "datasource": { "type": "loki", "uid": "${loki_datasource}" },
      "options": {
        "dedupStrategy": "none",
        "showLabels": false,
        "showCommonLabels": true,
        "wrapLogMessage": true,
        "prettifyLogMessage": true,
        "enableLogDetails": true,
        "sortOrder": "Descending",
        "showTime": true
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "type": "loki", "uid": "${loki_datasource}" },
          "expr": "{app=\"mentor-api\", namespace=\"$namespace\"} | json | level=~\"error|warn\"",
          "queryType": "range"
        }
      ]
    }
  ]
}
